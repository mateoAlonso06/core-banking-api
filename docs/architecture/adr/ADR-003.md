# ADR-003: Exception Hierarchy and Centralized Error Handling

## Status
Accepted

## Context
The application throws various domain exceptions (NotFound, AlreadyExists, validation errors, etc.) that need to:
- Map consistently to HTTP status codes
- Be handled in a single place (GlobalExceptionHandler)
- Allow adding new exceptions without modifying the handler
- Maintain clean service code without try-catch blocks everywhere

The initial approach had individual handlers for each exception, leading to repetitive code and the need to update the handler for every new exception.

## Decision
Implement a base exception hierarchy in `common/domain/exception/`:

```
DomainException (abstract)
├── ResourceNotFoundException      → 404 Not Found
├── ResourceAlreadyExistsException → 409 Conflict
├── AccessDeniedException          → 403 Forbidden
├── BusinessRuleException          → 422 Unprocessable Entity
├── AuthenticationException        → 401 Unauthorized
└── InfrastructureException        → 500 Internal Server Error
```

### Mapping

| Base Exception | HTTP Status | Use Case |
|----------------|-------------|----------|
| `ResourceNotFoundException` | 404 | Entity not found by ID |
| `ResourceAlreadyExistsException` | 409 | Duplicate entity (email, document) |
| `AccessDeniedException` | 403 | Authenticated user accessing a resource they do not own |
| `BusinessRuleException` | 422 | Domain rule violation (KYC not approved, limit exceeded) |
| `AuthenticationException` | 401 | Invalid credentials, expired token |
| `InfrastructureException` | 500 | External service failure, generation errors |

### Current Implementations

```
ResourceNotFoundException
├── AccountNotFoundException
├── CustomerNotFoundException
└── UserNotFoundException

ResourceAlreadyExistsException
├── AccountAlreadyExistsException
├── CustomerAlreadyExistsException
└── UserAlreadyExistsException

AccessDeniedException
├── InvalidAccountOwnerException
├── AccountAccessDeniedException
└── TransferAccessDeniedException

BusinessRuleException

AuthenticationException
└── InvalidCredentialsException

InfrastructureException
└── AliasGenerationFailedException
```

### GlobalExceptionHandler
Handles base types only:

```java
@ExceptionHandler(ResourceNotFoundException.class)
→ 404 + log.warn()

@ExceptionHandler(ResourceAlreadyExistsException.class)
→ 409 + log.warn()

@ExceptionHandler(AccessDeniedException.class)
→ 403 + log.warn()

@ExceptionHandler(BusinessRuleException.class)
→ 422 + log.warn()

@ExceptionHandler(AuthenticationException.class)
→ 401 + log.warn()

@ExceptionHandler(InfrastructureException.class)
→ 500 + log.error() (with stack trace)

@ExceptionHandler(Exception.class)
→ 500 + log.error() (catch-all, hides internal details)
```

## Consequences

### Positive
- New exceptions only need to extend the correct base class
- GlobalExceptionHandler remains unchanged when adding exceptions
- Consistent HTTP responses across the application
- Logging centralized (warn for client errors, error for server errors)
- Services stay clean without try-catch blocks

### Negative
- Requires understanding the hierarchy to choose the correct base
- Abstract base classes prevent instantiation (must create specific exceptions)

## Usage

To add a new exception:

```java
// 1. Create in the module's domain/exception package
public class InsufficientBalanceException extends BusinessRuleException {
    public InsufficientBalanceException(String message) {
        super(message);
    }
}

// 2. Throw it - handler already knows how to process it
if (account.getBalance().isLessThan(amount)) {
    throw new InsufficientBalanceException("Insufficient balance for transfer");
}
```

## Related
- ADR-001: Value Objects
- ADR-002: Account Identifiers
